<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey App - Home</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container" id="topSetup">
      <header>

        <button class="dark-toggle-btn" onclick="toggleDarkMode()">
          🌙 Dark Mode
        </button>

        <button
        onclick="
        localStorage.removeItem('currentUser');
        localStorage.removeItem('editSurveyId');
        location.href='index.html';
           "
           class="logout-btn"
         >
          Logout
        </button>
      </header>

      <div class="page-title">
        <h1>Home Page</h1>
      </div>

      <div class="pageTop">
        <div class="links">
          <button onclick="location.href='settings.html'">
            Account Settings
          </button>
          <button
          onclick="localStorage.removeItem('editSurveyId'); location.href='create.html';">Create Survey</button>
                  <button onclick="location.href='completed.html'">
            Completed Surveys
          </button>
          <button onclick="location.href='complete.html'">
            Complete a Survey
          </button>
        </div>
        <img src="pages.png" alt="Notebook" class="top-image" />
      </div>

      <h2 id="available-header">Available Surveys For You</h2>
      <div id="available-surveys" class="surveys-list"></div>

      <h2 id="your-header">Surveys Created By You</h2>
      <div id="your-surveys" class="surveys-list"></div>

      <div id="credits">
        <h3>Created by:</h3>
        <h3>Matthew, Bowen, and Gleb</h3>
      </div>
    </div>

    <script src="scripts.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        /* guard: must be logged in */
        if (!isLoggedIn()) {
            window.location = 'index.html';
            return;
        }

        const me = getCurrentUser();
        let surveys = [];

        /* fetch every survey in the system */
        try {
            const r = await fetch('http://127.0.0.1:3000/api/surveys', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            surveys = await r.json();
        } catch (e) {
            console.error(e);
            alert('Could not load surveys from server.');
            return;
        }

        /* split list */
        const available = surveys.filter(
              s => (s.createdBy || '').toLowerCase() !== me.username.toLowerCase());
        const mine      = surveys.filter(
              s => (s.createdBy || '').toLowerCase() === me.username.toLowerCase());

        /* render both lists */
        renderList('available-surveys', available, false);
        renderList('your-surveys',      mine,      true);

                /* helper ---------- */
                function renderList(targetId, list, editable) {
                  const host = document.getElementById(targetId);
                  host.innerHTML = '';
      
                  if (!list.length) {
                      host.innerHTML =
                          `<p>${editable
                              ? 'You have not created any surveys yet.'
                              : 'No surveys available right now.'}</p>`;
                      return;
                  }
      
                  list.forEach(s => {
                      const card = document.createElement('div');
                      card.className = 'survey-card';
      
                      card.innerHTML = `
                          <h4>${s.title}</h4>
                          <p>${s.description || ''}</p>
                      `;
      
                      /* ── buttons ─────────────────────────────────────────── */
                      if (editable) {
                          /* Edit button */
                          const editBtn = document.createElement('button');
                          editBtn.textContent = 'Edit Survey';
                          editBtn.addEventListener('click', () => {
                              localStorage.setItem('editSurveyId', s._id);
                              window.location = 'create.html';
                          });
      
                          /* Delete button */
                          const delBtn = document.createElement('button');
                          delBtn.textContent = 'Delete';
                          delBtn.className   = 'danger';
                          delBtn.addEventListener('click', async () => {
                            if (!confirm('Delete this survey permanently?')) return;

                            try {
                              const r = await fetch(`http://127.0.0.1:3000/api/surveys/${s._id}`, {
                                method : 'DELETE',
                                headers: { Authorization: `Bearer ${getToken()}` }
                              });
                              if (!r.ok) {
                                const msg = await r.text();
                                throw new Error(msg || 'Server error');
                              }

                              /* 1️⃣  splice out the deleted survey */
                              const arr = editable ? mine : available;
                              const idx = arr.findIndex(x => x._id === s._id);
                              if (idx !== -1) arr.splice(idx, 1);

                              /* 2️⃣  rerender that block only */
                              renderList(targetId, arr, editable);
                            } catch (e) {
                              alert('Could not delete survey.\n' + e.message);
                            }
                          });

      
                          card.appendChild(editBtn);
                          card.appendChild(delBtn);
      
                      } else {
                          /* Take-survey button */
                          const takeBtn = document.createElement('button');
                          takeBtn.textContent = 'Take Survey';
                          takeBtn.addEventListener('click', () => {
                              localStorage.setItem('selectedSurveyId', s._id);
                              window.location = 'complete.html';
                          });
      
                          card.appendChild(takeBtn);
                      }
      
                      host.appendChild(card);
                  });
              }
      
    });
    </script>
    <script>
      // Load dark mode from localStorage
      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark");
        }
      });
    
      function toggleDarkMode() {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        localStorage.setItem("darkMode", isDark);
      }
    </script>
    
  </body>
</html>
